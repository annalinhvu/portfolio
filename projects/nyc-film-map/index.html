<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NYC Film Scene Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --paper:#f4efe6;--paper-2:#ece7dd;--paper-3:#e2ddd3;
  --ink:#2c2420;--ink-2:#5c5248;--ink-3:#8a7e72;--ink-4:#b0a698;--ink-5:#ccc4b8;
  --accent:#b8453e;--accent-light:#d4756e;
  --surface:#f4efe6;--surface-2:#ece7dd;
  --border:#ddd6ca;--radius:3px;
  --sidebar-w:340px;
  --cat-cinema:#c4726c;
  --cat-lab:#8a9a6c;
  --cat-museum:#b8a472;
  --cat-org:#7a8a9a;
  --cat-school:#7a9a72;
  --sans:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
}

body{
  font-family:Georgia,'Times New Roman',serif;
  background:var(--paper);color:var(--ink);
  height:100vh;overflow:hidden;display:flex;flex-direction:column;
}

/* ── Top bar ── */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;height:52px;min-height:52px;
  background:var(--surface);border-bottom:1px solid var(--border);
  z-index:1000;
}
.topbar a{
  color:var(--ink-4);text-decoration:none;font-size:.65rem;
  font-family:var(--sans);
  letter-spacing:1px;text-transform:uppercase;transition:color .2s;
}
.topbar a:hover{color:var(--accent)}
.topbar-center{text-align:center}
.topbar-title{
  font-size:.95rem;font-weight:400;color:var(--ink);
  letter-spacing:3.5px;text-transform:uppercase;
}
.topbar-sub{
  font-size:.55rem;color:var(--ink-4);letter-spacing:2px;
  text-transform:uppercase;margin-top:1px;
  font-family:var(--sans);
}
.topbar-spacer{width:80px}

/* ── Main layout ── */
.main{display:flex;flex:1;overflow:hidden;position:relative}

/* ── Sidebar ── */
.sidebar{
  width:var(--sidebar-w);min-width:var(--sidebar-w);
  background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;z-index:900;
}
.sidebar-header{padding:16px 20px 14px;border-bottom:1px solid var(--border)}
.sidebar-header h2{
  font-size:.55rem;color:var(--ink-4);font-weight:400;
  margin-bottom:12px;letter-spacing:3px;text-transform:uppercase;
  font-family:var(--sans);
}

/* Category tags */
.cat-tags{display:flex;flex-wrap:wrap;gap:4px 12px;margin-bottom:14px}
.cat-tag{
  display:inline-flex;align-items:center;gap:5px;
  padding:2px 0;font-size:.62rem;
  font-family:var(--sans);
  letter-spacing:0.8px;text-transform:uppercase;
  cursor:pointer;border:none;border-bottom:1.5px solid transparent;
  transition:all .2s;user-select:none;
  background:transparent;color:var(--ink-4);
}
.cat-tag .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.cat-tag .diamond{width:7px;height:7px;flex-shrink:0;transform:rotate(45deg);border-radius:1px}
.cat-tag .hex{width:7px;height:7px;flex-shrink:0;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%)}
.cat-tag .tri{width:0;height:0;flex-shrink:0;border-left:3.5px solid transparent;border-right:3.5px solid transparent;border-bottom:7px solid currentColor}
.cat-tag:hover{color:var(--ink-3)}
.cat-tag.active{border-bottom-color:var(--ink-3);color:var(--ink-2)}

.filters-row{display:flex;gap:8px}
.filters-row select,.filters-row input{
  flex:1;padding:5px 8px;border-radius:var(--radius);
  border:1px solid var(--border);background:transparent;
  color:var(--ink);font-size:.72rem;outline:none;transition:border-color .2s;
  font-family:var(--sans);
}
.filters-row select:focus,.filters-row input:focus{border-color:var(--ink-4)}

.venue-count{
  padding:7px 20px;font-size:.55rem;color:var(--ink-5);
  border-bottom:1px solid var(--paper-3);letter-spacing:1.5px;
  text-transform:uppercase;
  font-family:var(--sans);
}

/* ── Venue list ── */
.venue-list{flex:1;overflow-y:auto;padding:2px 0}
.venue-entry{
  padding:9px 20px;cursor:pointer;
  border-bottom:1px solid var(--paper-2);
  transition:all .15s;
  border-left:2px solid transparent;
}
.venue-entry:hover{background:var(--paper-2)}
.venue-entry.active{background:var(--paper-2);border-left-color:var(--accent)}
.venue-entry-top{display:flex;align-items:baseline;gap:7px}
.venue-entry-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;position:relative;top:0}
.venue-entry-diamond{width:6px;height:6px;flex-shrink:0;position:relative;top:0;transform:rotate(45deg);border-radius:1px}
.venue-entry-hex{width:6px;height:6px;flex-shrink:0;position:relative;top:0;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%)}
.venue-entry-tri{width:0;height:0;flex-shrink:0;position:relative;top:1px;border-left:3px solid transparent;border-right:3px solid transparent;border-bottom:6px solid currentColor}
.venue-entry-name{
  font-size:.78rem;font-weight:400;color:var(--ink);
  font-family:Georgia,'Times New Roman',serif;
}
.venue-entry-sep{color:var(--ink-5);font-size:.72rem}
.venue-entry-hood{
  font-size:.68rem;color:var(--ink-3);font-style:italic;
}
.venue-entry-note{
  font-size:.68rem;color:var(--ink-4);margin-top:2px;font-style:italic;
  line-height:1.3;padding-left:13px;
}

/* ── Venue detail ── */
.venue-detail{flex:1;overflow-y:auto;padding:20px;display:none}
.venue-detail.visible{display:block}
.venue-detail-back{
  background:none;border:none;color:var(--accent);cursor:pointer;
  font-size:.65rem;margin-bottom:16px;padding:0;letter-spacing:1px;
  text-transform:uppercase;
  font-family:var(--sans);
}
.venue-detail-back:hover{text-decoration:underline}
.venue-detail h3{font-size:1.05rem;margin-bottom:4px;font-weight:400;letter-spacing:1px}
.venue-detail .cat-label{
  display:inline-block;font-size:.55rem;color:var(--ink-4);
  letter-spacing:1.5px;text-transform:uppercase;margin-bottom:14px;
  font-family:var(--sans);
}
.venue-detail .detail-field{margin-bottom:12px}
.venue-detail .detail-label{
  font-size:.5rem;color:var(--ink-5);text-transform:uppercase;
  letter-spacing:1.5px;margin-bottom:3px;
  font-family:var(--sans);
}
.venue-detail .detail-value{font-size:.8rem;color:var(--ink);line-height:1.6}
.venue-detail .detail-value a{color:var(--accent);text-decoration:none}
.venue-detail .detail-value a:hover{text-decoration:underline}

/* ── Map area ── */
.map-area{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* ── Legend bar ── */
.legend-bar{
  display:flex;align-items:center;gap:18px;
  padding:8px 20px;
  background:var(--surface-2);border-bottom:1px solid var(--border);
  font-family:var(--sans);font-size:.6rem;
  color:var(--ink-3);letter-spacing:1px;text-transform:uppercase;
}
.legend-bar .count{color:var(--ink-4);font-weight:500}
.legend-item{display:inline-flex;align-items:center;gap:4px}
.legend-dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.legend-diamond{width:7px;height:7px;display:inline-block;transform:rotate(45deg);border-radius:1px}
.legend-hex{width:7px;height:7px;display:inline-block;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%)}
.legend-tri{width:0;height:0;display:inline-block;border-left:3.5px solid transparent;border-right:3.5px solid transparent;border-bottom:7px solid var(--cat-school)}

/* ── Leaflet map ── */
.map-wrap{flex:1;position:relative}
#map{width:100%;height:100%}

/* Vintage filter on tiles */
.leaflet-tile-pane{filter:sepia(0.3) saturate(0.85)}

/* Clean up leaflet controls */
.leaflet-control-attribution{font-size:9px!important;background:rgba(244,239,230,.85)!important;color:var(--ink-4)!important}
.leaflet-control-attribution a{color:var(--ink-3)!important}
.leaflet-control-zoom a{
  background:var(--surface)!important;color:var(--ink-3)!important;
  border-color:var(--border)!important;
}
.leaflet-control-zoom a:hover{background:var(--paper-2)!important;color:var(--ink)!important}

/* Leaflet popups — clean white card */
.leaflet-popup-content-wrapper{
  background:#fff;border-radius:4px;
  box-shadow:0 2px 12px rgba(0,0,0,.1);
  padding:0;
}
.leaflet-popup-content{
  margin:12px 14px;font-family:Georgia,serif;font-size:13px;line-height:1.4;
}
.leaflet-popup-tip{background:#fff}
.popup-name{font-weight:400;font-size:14px;margin-bottom:3px;letter-spacing:0.3px}
.popup-hood{color:var(--ink-3);font-size:12px;font-style:italic;margin-bottom:2px}
.popup-highlight{color:var(--ink-4);font-size:11px;font-style:italic;line-height:1.35}
.popup-cat{
  color:var(--ink-5);font-size:10px;margin-top:4px;letter-spacing:1px;
  text-transform:uppercase;font-family:var(--sans);
}

/* ── Responsive ── */
@media(max-width:768px){
  .main{flex-direction:column-reverse}
  .sidebar{width:100%;min-width:100%;max-height:45vh;min-height:140px;border-right:none;border-top:1px solid var(--border)}
  .sidebar-header h2{display:none}
  :root{--sidebar-w:100%}
  .legend-bar{flex-wrap:wrap;gap:8px 14px}
}
.venue-list::-webkit-scrollbar,.venue-detail::-webkit-scrollbar{width:2px}
.venue-list::-webkit-scrollbar-thumb,.venue-detail::-webkit-scrollbar-thumb{background:var(--ink-5);border-radius:2px}
</style>
</head>
<body>

<div class="topbar">
  <a href="../../index.html">&larr; Portfolio</a>
  <div class="topbar-center">
    <div class="topbar-title">NYC Film Scene Map</div>
    <div class="topbar-sub">cinemas &middot; labs &middot; museums &middot; schools</div>
  </div>
  <div class="topbar-spacer"></div>
</div>

<div class="main">
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>Index</h2>
      <div class="cat-tags" id="catTags"></div>
      <div class="filters-row">
        <select id="boroughSelect"><option value="">All boroughs</option></select>
        <input type="text" id="searchInput" placeholder="Search...">
      </div>
    </div>
    <div class="venue-count" id="venueCount"></div>
    <div class="venue-list" id="venueList"></div>
    <div class="venue-detail" id="venueDetail"></div>
  </aside>
  <div class="map-area">
    <div class="legend-bar" id="legendBar"></div>
    <div class="map-wrap">
      <div id="map"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = '';
const CATEGORIES = ['cinema','lab','museum','organization','school'];
const CAT_LABELS = {cinema:'Cinema',lab:'Lab',museum:'Museum',organization:'Org',school:'School'};
const CAT_COLORS = {
  cinema:'#c4726c',
  lab:'#8a9a6c',
  museum:'#b8a472',
  organization:'#7a8a9a',
  school:'#7a9a72'
};

let allVenues = [];
let activeCategories = new Set(CATEGORIES);
let currentBorough = '';
let currentSearch = '';
let selectedId = null;

let map, markerLayer;
let markerMap = {}; // id → leaflet marker

// ── Leaflet Map ──
function initMap(){
  map = L.map('map',{zoomControl:true}).setView([40.730,-73.975],12);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains:'abcd',
    maxZoom:19
  }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);
}

// ── SVG Marker Icons ──
function makeIcon(category){
  var color = CAT_COLORS[category] || '#888';
  var svg;
  switch(category){
    case 'cinema':
      svg = '<circle cx="10" cy="10" r="7" fill="'+color+'" stroke="#fff" stroke-width="1.5" opacity="0.9"/>';
      break;
    case 'lab':
      svg = '<circle cx="10" cy="10" r="7" fill="'+color+'" stroke="#fff" stroke-width="1.5" opacity="0.9"/>';
      break;
    case 'museum':
      svg = '<rect x="4" y="4" width="12" height="12" rx="1" fill="'+color+'" stroke="#fff" stroke-width="1.5" opacity="0.9" transform="rotate(45 10 10)"/>';
      break;
    case 'organization':
      svg = '<polygon points="10,2 17.66,5.5 17.66,14.5 10,18 2.34,14.5 2.34,5.5" fill="'+color+'" stroke="#fff" stroke-width="1.5" opacity="0.9"/>';
      break;
    case 'school':
      svg = '<polygon points="10,2 18,17 2,17" fill="'+color+'" stroke="#fff" stroke-width="1.5" opacity="0.9"/>';
      break;
    default:
      svg = '<circle cx="10" cy="10" r="7" fill="'+color+'" stroke="#fff" stroke-width="1.5" opacity="0.9"/>';
  }
  return L.divIcon({
    html:'<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">'+svg+'</svg>',
    className:'',
    iconSize:[20,20],
    iconAnchor:[10,10],
    popupAnchor:[0,-12]
  });
}

function makeSelectedIcon(category){
  var color = CAT_COLORS[category] || '#888';
  var svg;
  switch(category){
    case 'cinema':
    case 'lab':
      svg = '<circle cx="13" cy="13" r="10" fill="'+color+'" stroke="#fff" stroke-width="2" opacity="0.95"/>';
      break;
    case 'museum':
      svg = '<rect x="4.5" y="4.5" width="17" height="17" rx="1.5" fill="'+color+'" stroke="#fff" stroke-width="2" opacity="0.95" transform="rotate(45 13 13)"/>';
      break;
    case 'organization':
      svg = '<polygon points="13,1 22,5.5 22,17.5 13,22 4,17.5 4,5.5" fill="'+color+'" stroke="#fff" stroke-width="2" opacity="0.95"/>';
      break;
    case 'school':
      svg = '<polygon points="13,1 24,22 2,22" fill="'+color+'" stroke="#fff" stroke-width="2" opacity="0.95"/>';
      break;
    default:
      svg = '<circle cx="13" cy="13" r="10" fill="'+color+'" stroke="#fff" stroke-width="2" opacity="0.95"/>';
  }
  return L.divIcon({
    html:'<svg width="26" height="26" viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg">'+svg+'</svg>',
    className:'',
    iconSize:[26,26],
    iconAnchor:[13,13],
    popupAnchor:[0,-15]
  });
}

// ── Build Markers ──
function buildMarkers(){
  markerLayer.clearLayers();
  markerMap = {};
  var filtered = getFiltered();

  filtered.forEach(function(v){
    if(v.lat == null || v.lng == null) return;
    var icon = makeIcon(v.category);
    var m = L.marker([v.lat,v.lng],{icon:icon});

    var popupHtml = '<div class="popup-name">'+escHtml(v.name)+'</div>'
      +'<div class="popup-hood">'+(v.neighborhood||'')+'</div>'
      +(v.highlight?'<div class="popup-highlight">'+escHtml(v.highlight)+'</div>':'')
      +'<div class="popup-cat">'+escHtml(CAT_LABELS[v.category]||v.category)+'</div>';
    m.bindPopup(popupHtml,{maxWidth:220,closeButton:true});

    m.on('click',function(){
      window.location.hash = '#venue/'+v.id;
    });

    m.addTo(markerLayer);
    markerMap[v.id] = m;
  });
}

function escHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function selectVenue(id){
  // Reset previous selection
  if(selectedId != null && markerMap[selectedId]){
    var prevV = allVenues.find(function(x){return x.id===selectedId;});
    if(prevV) markerMap[selectedId].setIcon(makeIcon(prevV.category));
  }
  selectedId = id;
  if(id != null && markerMap[id]){
    var v = allVenues.find(function(x){return x.id===id;});
    if(v){
      markerMap[id].setIcon(makeSelectedIcon(v.category));
      map.setView([v.lat,v.lng],Math.max(map.getZoom(),14),{animate:true});
      markerMap[id].openPopup();
    }
  }
}

// ── Legend ──
function renderLegend(count){
  var el = document.getElementById('legendBar');
  el.innerHTML = '<span class="count">'+count+' venues</span>'
    +'<span class="legend-item"><span class="legend-dot" style="background:var(--cat-cinema)"></span> Cinema</span>'
    +'<span class="legend-item"><span class="legend-dot" style="background:var(--cat-lab)"></span> Lab</span>'
    +'<span class="legend-item"><span class="legend-diamond" style="background:var(--cat-museum)"></span> Museum</span>'
    +'<span class="legend-item"><span class="legend-hex" style="background:var(--cat-org)"></span> Org</span>'
    +'<span class="legend-item"><span class="legend-tri"></span> School</span>';
}

// ── Category tags ──
function shapeHtml(cat,size){
  var s = size || 7;
  var color = CAT_COLORS[cat];
  switch(cat){
    case 'cinema':
    case 'lab':
      return '<span class="dot" style="background:'+color+';width:'+s+'px;height:'+s+'px"></span>';
    case 'museum':
      return '<span class="diamond" style="background:'+color+';width:'+s+'px;height:'+s+'px"></span>';
    case 'organization':
      return '<span class="hex" style="background:'+color+';width:'+s+'px;height:'+s+'px"></span>';
    case 'school':
      return '<span class="tri" style="border-bottom-color:'+color+';border-left-width:'+(s/2)+'px;border-right-width:'+(s/2)+'px;border-bottom-width:'+s+'px"></span>';
    default:
      return '<span class="dot" style="background:'+color+'"></span>';
  }
}

function entryShapeHtml(cat){
  var color = CAT_COLORS[cat];
  switch(cat){
    case 'cinema':
    case 'lab':
      return '<span class="venue-entry-dot" style="background:'+color+'"></span>';
    case 'museum':
      return '<span class="venue-entry-diamond" style="background:'+color+'"></span>';
    case 'organization':
      return '<span class="venue-entry-hex" style="background:'+color+'"></span>';
    case 'school':
      return '<span class="venue-entry-tri" style="color:'+color+'"></span>';
    default:
      return '<span class="venue-entry-dot" style="background:'+color+'"></span>';
  }
}

function renderTags(){
  var container = document.getElementById('catTags');
  container.innerHTML = CATEGORIES.map(function(c){
    return '<span class="cat-tag '+(activeCategories.has(c)?'active':'')+'" data-cat="'+c+'">'
      +shapeHtml(c)
      +CAT_LABELS[c]+'</span>';
  }).join('');
  container.querySelectorAll('.cat-tag').forEach(function(t){
    t.addEventListener('click',function(){
      var c = t.dataset.cat;
      if(activeCategories.has(c)) activeCategories.delete(c); else activeCategories.add(c);
      renderTags();
      applyFilters();
    });
  });
}

// ── Boroughs ──
function loadBoroughs(){
  return fetch(API+'/boroughs').then(function(r){return r.json();}).then(function(d){
    var s = document.getElementById('boroughSelect');
    d.forEach(function(b){
      var o = document.createElement('option');
      o.value = b.borough;
      o.textContent = b.borough+' ('+b.count+')';
      s.appendChild(o);
    });
  });
}
document.getElementById('boroughSelect').addEventListener('change',function(e){currentBorough=e.target.value;applyFilters();});
document.getElementById('searchInput').addEventListener('input',function(e){currentSearch=e.target.value.toLowerCase();applyFilters();});

// ── Data ──
function loadVenues(){
  return fetch(API+'/venues').then(function(r){return r.json();}).then(function(data){
    allVenues = data;
    buildMarkers();
    applyFilters();
  }).catch(function(e){
    console.error('loadVenues error:',e);
    document.getElementById('venueCount').textContent = 'Error loading venues';
  });
}

function getFiltered(){
  return allVenues.filter(function(v){
    if(!activeCategories.has(v.category)) return false;
    if(currentBorough && v.borough !== currentBorough) return false;
    if(currentSearch){
      var h = (v.name+' '+(v.neighborhood||'')+' '+(v.description||'')+' '+(v.highlight||'')).toLowerCase();
      if(h.indexOf(currentSearch) === -1) return false;
    }
    return true;
  });
}

function applyFilters(){
  var f = getFiltered();
  buildMarkers();
  renderVenueList(f);
  document.getElementById('venueCount').textContent = f.length+' venue'+(f.length!==1?'s':'');
  renderLegend(f.length);
}

// ── Sidebar ──
function renderVenueList(venues){
  var container = document.getElementById('venueList');
  if(!venues.length){
    container.innerHTML = '<div style="padding:20px;color:var(--ink-4);font-size:.78rem;font-style:italic">No results.</div>';
    return;
  }
  container.innerHTML = venues.map(function(v){
    return '<div class="venue-entry" data-id="'+v.id+'">'
      +'<div class="venue-entry-top">'
      +entryShapeHtml(v.category)
      +'<span class="venue-entry-name">'+escHtml(v.name)+'</span>'
      +'<span class="venue-entry-sep">&mdash;</span>'
      +'<span class="venue-entry-hood">'+(v.neighborhood||'')+'</span>'
      +'</div>'
      +(v.highlight?'<div class="venue-entry-note">'+escHtml(v.highlight)+'</div>':'')
      +'</div>';
  }).join('');
  container.querySelectorAll('.venue-entry').forEach(function(c){
    c.addEventListener('click',function(){window.location.hash='#venue/'+c.dataset.id;});
  });
}

function highlightCard(id){
  document.querySelectorAll('.venue-entry').forEach(function(c){c.classList.remove('active');});
  var c = document.querySelector('.venue-entry[data-id="'+id+'"]');
  if(c){c.classList.add('active');c.scrollIntoView({behavior:'smooth',block:'nearest'});}
  selectVenue(id);
}

// ── Detail ──
function showDetail(id){
  var v = allVenues.find(function(x){return x.id===id;});
  if(!v) return;
  var e = document.getElementById('venueDetail');
  e.innerHTML =
    '<button class="venue-detail-back" id="detailBack">&larr; Back to index</button>'
    +'<h3>'+escHtml(v.name)+'</h3>'
    +'<div class="cat-label">'+escHtml(CAT_LABELS[v.category])+'</div>'
    +(v.highlight?'<div class="detail-field"><div class="detail-value" style="font-style:italic;color:var(--ink-3)">'+escHtml(v.highlight)+'</div></div>':'')
    +(v.address?'<div class="detail-field"><div class="detail-label">Address</div><div class="detail-value">'+escHtml(v.address)+'</div></div>':'')
    +(v.neighborhood?'<div class="detail-field"><div class="detail-label">Neighborhood</div><div class="detail-value">'+escHtml(v.neighborhood)+', '+(v.borough||'')+'</div></div>':'')
    +(v.description?'<div class="detail-field"><div class="detail-label">About</div><div class="detail-value">'+escHtml(v.description)+'</div></div>':'')
    +(v.url?'<div class="detail-field"><div class="detail-label">Website</div><div class="detail-value"><a href="'+escHtml(v.url)+'" target="_blank" rel="noopener">'+escHtml(v.url.replace('https://','').replace('http://',''))+'</a></div></div>':'');
  e.classList.add('visible');
  document.getElementById('venueList').style.display = 'none';
  document.getElementById('venueCount').style.display = 'none';
  document.getElementById('detailBack').addEventListener('click',function(){window.location.hash='#map';});
  highlightCard(id);
}

function hideDetail(){
  document.getElementById('venueDetail').classList.remove('visible');
  document.getElementById('venueList').style.display = '';
  document.getElementById('venueCount').style.display = '';
  selectVenue(null);
}

// ── Routing ──
function handleRoute(){
  var h = window.location.hash || '#map';
  if(h.indexOf('#venue/') === 0){
    var id = parseInt(h.split('/')[1]);
    if(id) showDetail(id);
  } else {
    hideDetail();
  }
}
window.addEventListener('hashchange',handleRoute);

// ── Init ──
(function(){
  initMap();
  renderTags();
  renderLegend(0);
  Promise.all([loadBoroughs(),loadVenues()]).then(function(){
    handleRoute();
  }).catch(function(e){
    console.error('Init error:',e);
  });
})();
</script>
</body>
</html>
